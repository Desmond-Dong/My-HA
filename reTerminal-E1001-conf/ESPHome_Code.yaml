esphome:
  name: e1001
  friendly_name: E1001
  on_boot:
    priority: 600
    then:
      - output.turn_on: mic_enable
      - delay: 30s
      - component.update: dashboard_image
 #     - output.turn_on: bsp_sd_enable
      - output.turn_on: bsp_battery_enable
      - delay: 200ms
      - component.update: battery_voltage
      - component.update: battery_level

  project:
    name: francescopace.espectre
    version: "2.2.0"
esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf
    #type: arduino
# Enable logging
logger:
#  level: VERY_VERBOSE
#  logs:
#    microphone: VERY_VERBOSE
#    i2s_audio: VERY_VERBOSE
# Enable Home Assistant API
api:
  encryption:
    key: "lY+oz71tYyiQ8XgimOxMd6pYEyWhLzzXqhNYsZatTmw="
  services: # for playing music via Home Assistant
    - service: play_song
      variables:
        song_data: string
      then:
        - lambda: |-
            auto *bz = id(buzzer_pwm);
            std::string s = song_data;
            size_t start = 0;

            while (true) {
              size_t comma = s.find(',', start);
              std::string note = s.substr(start, comma - start);
              if (note.empty()) break;

              size_t colon = note.find(':');
              if (colon != std::string::npos) {
                int freq = atoi(note.substr(0, colon).c_str());
                int dur  = atoi(note.substr(colon + 1).c_str());

                if (freq > 0) {
                  // ✅ 正确写法
                  bz->update_frequency(freq);
                  bz->set_level(0.6);
                } else {
                  bz->set_level(0);
                }
                delay(dur);
              }

              if (comma == std::string::npos) break;
              start = comma + 1;
            }

            bz->set_level(0);
ota:
  - platform: esphome
    password: "6abb3deae74569ff3725fde6bac204e8"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Reterminal-E1001"
    password: "dkX2Ni4kwEQh"
#web_server:
#  version: 3
psram:
  mode: octal
  speed: 80MHz

captive_portal:

external_components:
  - source:
      type: git
      url: https://github.com/francescopace/espectre
      ref: main
    components: [ espectre ]
    refresh: always
#  - source:
#      type: local
#      path: "components"
espectre:
  id: espectre_csi


dashboard_import:
  package_import_url: github://francescopace/espectre/examples/espectre-s3.yaml@main
  import_full_config: true

# BLE Proxy
esp32_ble_tracker:
  scan_parameters:
    active: true
bluetooth_proxy:
  active: true

# Deep-sleep, wake by GPIO4
#deep_sleep:
#  id: deep_sleep_1
#  run_duration: 1min
#  sleep_duration: 10min
#  wakeup_pin: GPIO4          # Right white button
#  wakeup_pin_mode: INVERT_WAKEUP

i2s_audio:
  i2s_lrclk_pin: GPIO46 # Note: labeled as "useless"
  i2s_bclk_pin: GPIO42

# Configuration for the microphone using I2S audio
microphone:
  - platform: i2s_audio
    id: echo_microphone
    i2s_din_pin: GPIO41
    adc_type: external
    pdm: true
    use_apll: true
    channel: left
    on_data:
      - lambda: |-
          int32_t sum = 0;
          for (auto v : x) {
            sum += abs(v);
          }
          ESP_LOGW("MIC", "Energy=%ld", sum / (x.size() ? x.size() : 1));

# Configuration for the Voice Assistant
voice_assistant:
  microphone: echo_microphone
  use_wake_word: false
  noise_suppression_level: 0
  conversation_timeout: 300s
  volume_multiplier: 1.0



debug:
  update_interval: 5s

    
# SPI / I²C
spi:
  clk_pin: GPIO7
  mosi_pin: GPIO9
i2c:
  scl: GPIO20
  sda: GPIO19
light:
#  - platform: binary
#    name: "Onboard LED"
#    output: bsp_led
#    id: onboard_led
  - platform: monochromatic
    output: buzzer_pwm
    icon: "mdi:volume-high"
    name: "Buzzer"
    id: buzzer
    # Setting transition length to 0s makes the buzzer turn on and off instantly.
    default_transition_length: 0s
switch:
  - platform: template
    name: "Refresh"
    id: refresh_display
    turn_on_action:
      - lambda: |-
          id(dashboard_image).set_url(id(custom_url_input).state);
          id(dashboard_image).update();
          
      - delay: 500ms
      - switch.turn_off: refresh_display
#  - platform: template
#    name: "Force Deep Sleep"
#    turn_on_action:
#      - logger.log:
#          format: "进入休眠 %d 分钟"
#          args: [ 'id(sleep_minutes)' ]
#      - deep_sleep.enter:
#          id: deep_sleep_1
#          sleep_duration: !lambda 'return (id(sleep_minutes) * 60000);'

            
sensor:
  - platform: sht4x
    temperature:
      name: "Temperature"
      id: temp_sensor
    humidity:
      name: "Humidity"
      id: hum_sensor
  - platform: wifi_signal
    name: "Wi-Fi Signal"
    id: wifi_signal1
    update_interval: 60s
  - platform: adc
    pin: GPIO1
    name: "Battery Voltage"
    id: battery_voltage
    update_interval: 60s
    attenuation: 12db
    filters:
      - multiply: 2.0
  - platform: template
    name: "Battery Level"
    id: battery_level
    unit_of_measurement: "%"
    icon: "mdi:battery"
    device_class: battery
    state_class: measurement
    lambda: 'return id(battery_voltage).state;'
    update_interval: 60s
    filters:
      - calibrate_linear:
          - 4.15 -> 100.0
          - 3.96 -> 90.0
          - 3.91 -> 80.0
          - 3.85 -> 70.0
          - 3.80 -> 60.0
          - 3.75 -> 50.0
          - 3.68 -> 40.0
          - 3.58 -> 30.0
          - 3.49 -> 20.0
          - 3.41 -> 10.0
          - 3.30 -> 5.0
          - 3.27 -> 0.0
      - clamp:
          min_value: 0
          max_value: 100
  - platform: debug
    free:
      name: "Free Heap"
    block:
      name: "Max Free Block"
    loop_time:
      name: "Loop Time"
text:
  - platform: template
    name: "Custom Image URL"
    id: custom_url_input
    mode: TEXT
    # 这里你可以填入你想给第二页预设的默认地址
    initial_value: "http://172.16.1.119:10000/lovelace/4?viewport=800x480&eink=2&format=bmp&lang=zh-cn"
    optimistic: true
    restore_value: true
    max_length: 255
text_sensor:
  - platform: debug
    device:
      name: "Device Info"
    reset_reason:
      name: "Reset Reason"
output:
#  - platform: gpio
#    pin: GPIO6
#    id: bsp_led
#    inverted: true
#  - platform: gpio
#    pin: GPIO16
#    id: bsp_sd_enable
  - platform: gpio
    pin: GPIO21
    id: bsp_battery_enable
  - platform: ledc   # CORRECTED: 'ledc' is the correct platform for ESP32 PWM.
    pin: GPIO45
    id: buzzer_pwm
    # The frequency determines the pitch of the buzzer's sound. 1000Hz is a mid-range tone.
    frequency: 1000Hz

  - platform: gpio
    pin: GPIO38
    id: mic_enable


binary_sensor:
  - platform: gpio    # Next page
    pin:
      number: GPIO3
      mode: INPUT_PULLUP
      inverted: true
    id: key1
    name: "Key1"
  - platform: gpio     # Prev page
    pin:
      number: GPIO4
      mode: INPUT_PULLUP
      inverted: true
    id: key2
    name: "Key2"
    filters:
      - delayed_on: 30ms
      - delayed_off: 30ms
    on_press:
      - voice_assistant.start:

    on_release:
      - voice_assistant.stop:

  - platform: gpio     # Key3 物理刷新按键
    pin:
      number: GPIO5
      mode: INPUT_PULLUP
      inverted: true
    id: key3
    name: "Key3"
    on_press:
      - lambda: |-
          id(dashboard_image).set_url(id(custom_url_input).state);
          id(dashboard_image).update();
          

  # - platform: gpio
  #   pin:
  #     number: GPIO4
  #     mode: INPUT_PULLUP
  #     inverted: true
  #   id: key2
  #   name: "Key2"
  #   on_press:
  #     then:
  #       - lambda: |-
  #           id(page_index) = (id(page_index) - 1 + 3) % 3;
  #           id(epaper_display).update();

# Home Assistant time
#time:
#  - platform: homeassistant
#    id: ha_time
#globals:
#  - id: sleep_minutes
#    type: int
#    restore_value: no
#    initial_value: '0'

##number:
 # - platform: template
#    name: "Sleep Minutes"
#    id: sleep_minutes_number
#    optimistic: true
#    min_value: 1
#    max_value: 360
#    step: 1
#    set_action:
#      - lambda: |-
#          id(sleep_minutes) = (int)x;




#deep_sleep:
#  id: deep_sleep_1

http_request:
  verify_ssl: false
  timeout: 10s
  watchdog_timeout: 15s

#time:
#  - platform: sntp
#    id: sntp_time
#    timezone: Asia/Shanghai
#    on_time:
#      # 每个整点触发
#      - seconds: 0
#        minutes: 0
#        then:
#          - if:
#              condition:
#                # 判断小时数不是 1~6
#                lambda: |-
#                  auto now = id(sntp_time).now();
#                  return !(now.hour >= 1 && now.hour < 6);
#              then:
#                # 仅非 1~6 点执行更新
#                - component.update: dashboard_image
# 在线图片获取

online_image:
  - id: dashboard_image
    format: BMP
    type: BINARY
    buffer_size: 65535
    url: http://172.16.1.119:10000/lovelace/2?viewport=800x480&eink=2&format=bmp&lang=zh-cn
    on_download_finished:
      - component.update: epaper_display

# 墨水屏显示
display:
  - platform: waveshare_epaper
    id: epaper_display
    model: 7.50inv2
    cs_pin: GPIO10
    dc_pin: GPIO11
    reset_pin:
      number: GPIO12
      inverted: false
    busy_pin:
      number: GPIO13
      inverted: true
    update_interval: never   # 不自动刷新，靠 on_time 来触发
    lambda: |-
      it.image(0, 0, id(dashboard_image));